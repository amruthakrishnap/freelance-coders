<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Review Widget</title>
    <style>
        /* Your existing styles here */
    </style>
</head>
<body>
    <div class="review-widget">
        <div class="input-container" id="embed-container" style="display: none;">
            <input type="text" id="extensionUrl" placeholder="Enter extension URL">
            <button onclick="fetchReviews()">Fetch Reviews</button>
        </div>
        <div class="rating-summary">
            Google Reviews: <span id="ratingSummary">4.4 ★ (159)</span>
        </div>
        <div class="carousel-container" id="reviewCarousel">
            <!-- Reviews will be dynamically inserted here -->
        </div>
    </div>

    <!-- Modal -->
    <div class="modal" id="reviewModal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">×</span>
            <div id="modalUser"></div>
            <div id="modalPostedDate" class="posted-date"></div>
            <div id="modalStarRating" class="star-rating"></div>
            <div id="modalReviewContent"></div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@1.28.5/dist/umd/supabase.min.js"></script>
    <script>
        const { createClient } = window.supabase;
        const SUPABASE_URL = 'https://vjgxtqqrbehmoqsgorvq.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZqZ3h0cXFyYmVobW9xc2dvcnZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjI4NTI5ODcsImV4cCI6MjAzODQyODk4N30.Qlhws14rMtrM7frgxLKgM6flg3I1JvJ-JPd5gd6A3-Q';
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        async function fetchReviews() {
            try {
                const extensionUrl = document.getElementById('extensionUrl').value;

                // Fetch extension name based on the extension URL
                console.log('Fetching extension name from Supabase...');
                const { data: info, error: infoError } = await supabase
                    .from('extension_info')
                    .select('extension_name')
                    .eq('extension_url', extensionUrl)
                    .single();

                if (infoError) {
                    console.error('Error fetching extension name:', infoError.message);
                    return;
                }

                const extensionName = info.extension_name;

                console.log('Extension name fetched:', extensionName);

                // Fetch reviews based on extension name
                console.log('Fetching reviews from Supabase...');
                const { data: reviews, error: reviewsError } = await supabase
                    .from('extension_review')
                    .select('*')
                    .eq('extension_name', extensionName);

                if (reviewsError) {
                    console.error('Error fetching reviews:', reviewsError.message);
                    return;
                }

                console.log('Reviews data fetched:', reviews);
                renderReviews(reviews);

                // Fetch rating summary
                const { data: ratingInfo, error: ratingInfoError } = await supabase
                    .from('extension_info')
                    .select('overall_rating, total_rating')
                    .eq('extension_name', extensionName)
                    .single();

                if (ratingInfoError) {
                    console.error('Error fetching rating info:', ratingInfoError.message);
                    return;
                }

                console.log('Rating info fetched:', ratingInfo);
                updateRatingSummary(ratingInfo.overall_rating, ratingInfo.total_rating);
            } catch (err) {
                console.error('Error in fetchReviews:', err);
            }
        }

        function renderReviews(reviews) {
            const reviewContainer = document.getElementById('reviewCarousel');
            console.log('Rendering reviews...');
            reviewContainer.innerHTML = ''; // Clear existing reviews
            reviews.forEach(review => {
                console.log('Review:', review);
                const reviewCard = document.createElement('div');
                reviewCard.className = 'review-card';
                const daysAgo = Math.ceil((new Date() - new Date(review.date)) / (1000 * 60 * 60 * 24));

                reviewCard.innerHTML = `
                    <div class="review-user">
                        <img src="https://via.placeholder.com/40" alt="${review.name}" class="user-img">
                        <div>
                            <div class="user-name">${review.name}</div>
                            <div class="posted-date">${daysAgo} days ago</div>
                        </div>
                    </div>
                    <div class="star-rating">${'★'.repeat(Math.round(review.rating))}</div>
                    <div class="review-content">${review.review} <span class="read-more" onclick="showModal('${review.name}', '${daysAgo} days ago', ${review.rating}, '${review.review}')">Read more</span></div>
                `;
                reviewContainer.appendChild(reviewCard);
            });
        }

        function showModal(username, postedDate, starRating, fullReview) {
            console.log('Showing modal for:', username);
            const modal = document.getElementById('reviewModal');
            const modalUser = document.getElementById('modalUser');
            const modalPostedDate = document.getElementById('modalPostedDate');
            const modalStarRating = document.getElementById('modalStarRating');
            const modalReviewContent = document.getElementById('modalReviewContent');

            modalUser.textContent = username;
            modalPostedDate.textContent = postedDate;
            modalStarRating.textContent = '★'.repeat(Math.round(starRating));
            modalReviewContent.textContent = fullReview;
            modal.style.display = 'flex';
        }

        function closeModal() {
            console.log('Closing modal');
            document.getElementById('reviewModal').style.display = 'none';
        }

        function updateRatingSummary(overallRating, totalRating) {
            const ratingSummary = document.getElementById('ratingSummary');
            ratingSummary.textContent = `${overallRating} ★ (${totalRating})`;
        }

        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        document.addEventListener('DOMContentLoaded', () => {
            const extensionUrl = getUrlParameter('extension_url');
            if (extensionUrl) {
                document.getElementById('extensionUrl').value = extensionUrl;
                fetchReviews();
            } else {
                document.getElementById('embed-container').style.display = 'block';
            }
        });
    </script>
</body>
</html>
